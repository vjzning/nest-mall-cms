# 商城模块详细设计方案 (V2 - 优化版)

根据您的要求，我们进一步优化了设计：**分离用户体系 (Member vs User)**，**配置中心化 (System Config)**，以及 **支付能力模块化 (Shared Lib)**。

## 1. 核心架构变更点

*   **用户分离**：
    *   **管理端用户 (`UserEntity`)**：负责后台管理，RBAC 权限控制 (已存在)。
    *   **C 端会员 (`MemberEntity`)**：新增实体，负责商城下单、收货地址、个人中心。
*   **支付模块独立 (`libs/payment`)**：
    *   创建一个独立的 NestJS Library，封装支付逻辑。
    *   基于 **策略模式** 实现多种支付方式。
    *   **配置驱动**：支付参数（Key/Secret）不写死在代码中，而是从 `sys_config` 表读取。

## 2. 数据库设计 (Database Schema)

在 `libs/db/src/entities` 中新增以下实体：

### 2.1 会员体系 (Member)
*   **MemberEntity (`mall_member`)**
    *   `username` / `email` / `phone`: 登录凭证
    *   `password`: 密码 (独立加密)
    *   `nickname`, `avatar`: 基础信息
    *   `status`: 状态 (正常/禁用)
    *   `level`: 会员等级 (预留)

### 2.2 商品体系 (Product)
*   **MallProductEntity (`mall_product`)**
    *   基础: `name`, `categoryId`, `status` (上架/下架), `sort`
    *   展示: `cover`, `images` (JSON), `detail` (富文本)
    *   统计: `sales` (销量), `viewCount` (浏览量)
*   **MallProductSkuEntity (`mall_product_sku`)**
    *   `productId`: 关联商品
    *   `code`: SKU 编码 (唯一)
    *   `specs`: 规格 JSON (如 `[{key: "颜色", value: "红"}, {key: "尺码", value: "L"}]`)
    *   `price`: 销售价
    *   `marketPrice`: 市场价
    *   `stock`: 库存 (需考虑并发扣减)

### 2.3 订单体系 (Order)
*   **MallOrderEntity (`mall_order`)**
    *   `memberId`: **关联 Member 表** (非 User 表)
    *   `orderNo`: 订单号 (唯一业务主键)
    *   `totalAmount`: 订单总额
    *   `payAmount`: 实付金额 (扣除优惠后)
    *   `status`: 枚举 (PENDING_PAY, PENDING_DELIVERY, DELIVERED, COMPLETED, CANCELLED)
    *   `receiverInfo`: 收货人信息 JSON (姓名, 电话, 地址)
*   **MallOrderItemEntity (`mall_order_item`)**
    *   `orderId`: 关联订单
    *   `productId`, `skuId`: 关联商品快照
    *   `productName`, `productImg`, `skuSpecs`: 下单时快照信息
    *   `price`: 下单单价
    *   `quantity`: 数量

### 2.4 支付流水 (Payment)
*   **MallPaymentEntity (`mall_payment`)**
    *   `orderNo`: 关联订单号
    *   `transactionId`: 第三方支付单号
    *   `paymentMethod`: `alipay` | `wechat` | `balance`
    *   `amount`: 交易金额
    *   `status`: 支付状态 (SUCCESS, FAILED)
    *   `paidAt`: 支付时间

## 3. 支付模块设计 (`libs/payment`)

将创建一个 Shared Library: `nest g library payment`

### 3.1 核心接口 (Interfaces)
```typescript
export interface PaymentConfig {
  appId: string;
  privateKey: string;
  // ... 其他通用配置
}

export interface PaymentStrategy {
  // 发起支付，返回给前端的支付参数 (如支付宝的 form html 或 微信的 prepay_id)
  pay(order: MallOrderEntity): Promise<any>;
  
  // 处理回调
  verifyCallback(data: any): Promise<boolean>;
  
  // 查询订单状态
  query(orderNo: string): Promise<PaymentStatus>;
}
```

### 3.2 策略实现 (Strategies)
*   `AlipayStrategy`: 实现支付宝签名、验签逻辑。
*   `WechatPayStrategy`: 实现微信统一下单、回调解密逻辑。

### 3.3 支付工厂 (PaymentService)
*   依赖 `SystemConfigService` (或通过 DB Repository) 获取配置。
*   根据前端传入的 `method` (如 'alipay')，动态实例化对应的 Strategy，并注入从数据库读取的配置。

## 4. 系统配置 (System Config)

在 `sys_config` 表中预置以下 Key (Group: `payment`):
*   `payment.alipay.appId`
*   `payment.alipay.privateKey` (IsEncrypted: true)
*   `payment.alipay.publicKey`
*   `payment.wechat.mchId`
*   `payment.wechat.apiV3Key` (IsEncrypted: true)

## 5. 目录与职责划分

| 模块 | 目录 | 职责 |
| :--- | :--- | :--- |
| **Common DB** | `libs/db` | 存放所有 Entity (User, Member, Product, Order...) |
| **Payment Lib** | `libs/payment` | 支付策略、第三方 SDK 封装、验签逻辑 |
| **Admin API** | `apps/cms-admin-api` | **商品管理** (上架/SKU维护), **订单管理** (发货/退款), **会员管理** (查询/封禁), **支付配置** (设置Key) |
| **Content API** | `apps/cms-content-api` | **会员模块** (注册/登录), **商品展示**, **购物车**, **下单结算**, **支付回调接口** |

## 6. 实施路线图

1.  **创建基础库**:
    *   创建 `libs/payment`。
    *   定义 Entity 并同步数据库。
2.  **内容端 (Content API) 开发**:
    *   实现 Member 注册登录 (JWT)。
    *   实现商品列表接口。
    *   实现下单接口 (Order + OrderItem)。
3.  **管理端 (Admin API) 开发**:
    *   商品发布 (多 SKU 表单)。
    *   订单列表查看。
4.  **支付联调**:
    *   在 Admin 配置支付参数。
    *   Content 端调用 `PaymentService` 获取支付凭证。
