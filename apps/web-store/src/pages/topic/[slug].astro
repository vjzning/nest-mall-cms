---
import Layout from "../../layouts/Layout.astro";
import type { CollectionInfo } from "@app/shared";
import CollectionSection from "../../components/nike/CollectionSection.astro";
import { API_ENDPOINTS, request } from "../../lib/api";

// SSR 模式 - 每次请求动态渲染
const { slug } = Astro.params;

let collection: CollectionInfo | null = null;
try {
  collection = await request<CollectionInfo>(`${API_ENDPOINTS.COLLECTIONS}/${slug}`);
} catch (e) {
  console.error("Failed to fetch collection detail:", e);
}

if (!collection) {
  return Astro.redirect("/404");
}
---

<Layout title={collection.title}>
  <div class="pb-10">
    {/* Hero Banner with Cover Image */}
    {
      collection.coverImage && (
        <div class="relative w-full h-[60vh] mb-10 overflow-hidden">
          <img
            src={collection.coverImage}
            alt={collection.title}
            class="absolute inset-0 object-cover w-full h-full"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
          <div class="relative z-10 h-full flex flex-col justify-end max-w-[1920px] mx-auto px-4 sm:px-12 pb-16">
            {collection.subtitle && (
              <span class="mb-2 text-sm font-bold tracking-widest uppercase text-white/90">
                {collection.subtitle}
              </span>
            )}
            <h1 class="mb-4 text-5xl italic font-black tracking-tighter text-white uppercase md:text-7xl font-nike">
              {collection.title}
            </h1>
            <p class="max-w-2xl text-lg text-white/90">
              {collection.description}
            </p>
          </div>
        </div>
      )
    }

    {/* Title Section (if no cover image) */}
    {
      !collection.coverImage && (
        <div class="max-w-[1920px] mx-auto px-4 sm:px-12 py-10">
          {collection.subtitle && (
            <span class="block mb-2 text-xs font-bold tracking-widest uppercase text-nike-dark-grey">
              {collection.subtitle}
            </span>
          )}
          <h1 class="mb-4 text-4xl italic font-black tracking-tighter uppercase md:text-6xl font-nike">
            {collection.title}
          </h1>
          <p class="max-w-2xl text-lg text-nike-dark-grey">
            {collection.description}
          </p>
        </div>
      )
    }

    {/* Collection Content */}
    <CollectionSection collection={collection} />
  </div>
</Layout>
